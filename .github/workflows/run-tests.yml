name: Run Unit Tests

on:
  pull_request:
    paths:
      - 'projects/**/src/**/*.py'
      - 'projects/**/tests/**/*.py'
      - 'projects/**/setup.py'
      - 'projects/**/pytest.ini'
      - 'projects/**/requirements*.txt'
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'projects/**/src/**/*.py'
      - 'projects/**/tests/**/*.py'

jobs:
  detect-projects:
    name: Detect Changed Projects
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.set-projects.outputs.projects }}
      has_changes: ${{ steps.set-projects.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect projects with changes
        id: set-projects
        run: |
          # Default to all projects if on main/master/develop
          if [[ "${{ github.event_name }}" == "push" ]]; then
            PROJECTS='["high-risk-wifi","suspicious-location"]'
          else
            # Get changed files in PR
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

            # Find unique project directories
            PROJECTS=$(echo "$CHANGED_FILES" | grep '^projects/' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')
          fi

          echo "Projects to test: $PROJECTS"
          echo "projects=$PROJECTS" >> $GITHUB_OUTPUT

          if [ "$PROJECTS" = "[]" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  test:
    name: Test - ${{ matrix.project }}
    runs-on: ubuntu-latest
    needs: detect-projects
    if: needs.detect-projects.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.detect-projects.outputs.projects) }}
        python-version: ['3.10', '3.11']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install Java (for PySpark)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.project }}-${{ hashFiles(format('projects/{0}/requirements*.txt', matrix.project)) }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.project }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        working-directory: projects/${{ matrix.project }}
        run: |
          python -m pip install --upgrade pip setuptools wheel

          # Install project dependencies
          if [ -f "setup.py" ]; then
            pip install -e .
          fi

          # Install dev dependencies
          if [ -f "requirements-dev.txt" ]; then
            pip install -r requirements-dev.txt
          else
            # Fallback to essential testing packages
            pip install pytest pytest-cov pytest-mock pyspark
          fi

      - name: Run unit tests
        working-directory: projects/${{ matrix.project }}
        run: |
          if [ -d "tests" ]; then
            echo "Running tests for ${{ matrix.project }}"
            pytest tests/ \
              -v \
              --tb=short \
              --cov=src \
              --cov-report=term-missing \
              --cov-report=xml \
              --cov-report=html \
              --junit-xml=test-results.xml || {
              echo "::error::Tests failed for ${{ matrix.project }}"
              exit 1
            }
          else
            echo "::warning::No tests directory found for ${{ matrix.project }}"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.10'
        with:
          files: ./projects/${{ matrix.project }}/coverage.xml
          flags: ${{ matrix.project }}
          name: ${{ matrix.project }}-coverage
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.project }}-py${{ matrix.python-version }}
          path: |
            projects/${{ matrix.project }}/test-results.xml
            projects/${{ matrix.project }}/htmlcov/
          if-no-files-found: ignore

      - name: Publish test summary
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always() && matrix.python-version == '3.10'
        with:
          files: projects/${{ matrix.project }}/test-results.xml
          check_name: Test Results - ${{ matrix.project }}

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [detect-projects, test]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.detect-projects.outputs.has_changes }}" = "false" ]; then
            echo "ℹ️ No changes detected requiring tests"
            exit 0
          fi

          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "✅ All tests passed"
          elif [ "${{ needs.test.result }}" = "skipped" ]; then
            echo "⏭️ Tests skipped"
          else
            echo "❌ Tests failed"
            exit 1
          fi

      - name: Post summary
        if: needs.detect-projects.outputs.has_changes == 'true'
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Projects Tested:** ${{ needs.detect-projects.outputs.projects }}" >> $GITHUB_STEP_SUMMARY
          echo "**Python Versions:** 3.10, 3.11" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "✅ **Status:** All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status:** Tests failed" >> $GITHUB_STEP_SUMMARY
          fi
