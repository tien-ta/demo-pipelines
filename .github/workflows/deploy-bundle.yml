name: Deploy Databricks Bundle

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project to deploy'
        required: true
        type: choice
        options:
          - high_risk_wifi
          - suspicious_location
      tag:
        description: 'Git tag to deploy (optional, leave empty to deploy from current branch)'
        required: false
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      dry_run:
        description: 'Dry run mode (validate only, no deployment)'
        required: false
        type: boolean
        default: true

jobs:
  deploy:
    name: Deploy ${{ inputs.project }} to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Determine deployment source
        id: deploy-source
        run: |
          PROJECT="${{ inputs.project }}"
          TAG="${{ inputs.tag }}"

          if [ -n "$TAG" ]; then
            # Tag provided - extract version from tag
            if [[ ! "$TAG" =~ ^([a-z_]+)-([0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
              echo "‚ùå Error: Tag must be in format <project-name>-<version> (e.g., high_risk_wifi-0.1.1)"
              exit 1
            fi

            TAG_PROJECT="${BASH_REMATCH[1]}"
            VERSION="${BASH_REMATCH[2]}"

            # Verify tag matches selected project
            if [ "$TAG_PROJECT" != "$PROJECT" ]; then
              echo "‚ùå Error: Tag project '$TAG_PROJECT' does not match selected project '$PROJECT'"
              exit 1
            fi

            echo "ref=$TAG" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "source=tag" >> $GITHUB_OUTPUT

            echo "‚úÖ Deploying from tag:"
            echo "  Project: $PROJECT"
            echo "  Tag: $TAG"
            echo "  Version: $VERSION"
          else
            # No tag - deploy from current branch, read version from version.yml
            echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
            echo "source=branch" >> $GITHUB_OUTPUT

            echo "‚úÖ Deploying from current branch:"
            echo "  Project: $PROJECT"
            echo "  Branch: ${{ github.ref_name }}"
          fi

          echo "project=$PROJECT" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.deploy-source.outputs.ref }}
          fetch-depth: 0

      - name: Get version from version.yml
        if: steps.deploy-source.outputs.source == 'branch'
        id: get-version
        run: |
          PROJECT="${{ steps.deploy-source.outputs.project }}"
          VERSION_FILE="projects/$PROJECT/version.yml"

          if [ ! -f "$VERSION_FILE" ]; then
            echo "‚ùå Error: $VERSION_FILE not found"
            exit 1
          fi

          VERSION=$(grep -E "^\s+code:\s+" "$VERSION_FILE" | sed -E 's/.*code:\s+"([^"]+)".*/\1/')

          if [ -z "$VERSION" ]; then
            echo "‚ùå Error: Could not extract version from $VERSION_FILE"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version from version.yml: $VERSION"

      - name: Verify project exists
        run: |
          PROJECT="${{ steps.deploy-source.outputs.project }}"

          if [ ! -d "projects/$PROJECT" ]; then
            echo "‚ùå Error: Project directory 'projects/$PROJECT' does not exist"
            exit 1
          fi

          if [ ! -f "projects/$PROJECT/databricks.yml" ]; then
            echo "‚ùå Error: databricks.yml not found in projects/$PROJECT"
            exit 1
          fi

          echo "‚úÖ Project directory and databricks.yml found"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Databricks CLI
        run: |
          echo "Installing Databricks CLI"
          echo "Running: pip install databricks-cli"
          echo "‚úì Databricks CLI installed (dry-run mode)"

      - name: Build Python package
        working-directory: projects/${{ steps.deploy-source.outputs.project }}
        if: hashFiles('projects/${{ steps.deploy-source.outputs.project }}/setup.py') != ''
        run: |
          echo "Building Python package for ${{ steps.deploy-source.outputs.project }}"
          echo "Running: pip install --upgrade pip build"
          echo "Running: python -m build --wheel --outdir dist/"
          echo "‚úì Python package built successfully (dry-run mode)"

      - name: Validate bundle
        working-directory: projects/${{ steps.deploy-source.outputs.project }}
        run: |
          echo "Validating Databricks bundle for ${{ steps.deploy-source.outputs.project }}"
          echo "Target: ${{ inputs.environment }}"
          echo "Running: databricks bundle validate -t ${{ inputs.environment }}"
          echo "‚úì Bundle validation successful (dry-run mode)"

      - name: Deploy bundle
        if: inputs.dry_run == false
        working-directory: projects/${{ steps.deploy-source.outputs.project }}
        run: |
          VERSION="${{ steps.deploy-source.outputs.version }}${{ steps.get-version.outputs.version }}"
          echo "Deploying ${{ steps.deploy-source.outputs.project }} version $VERSION"
          echo "Environment: ${{ inputs.environment }}"
          echo "Running: databricks bundle deploy -t ${{ inputs.environment }}"
          echo "‚úì Bundle deployed successfully (dry-run mode)"

      - name: Dry run summary
        if: inputs.dry_run == true
        run: |
          VERSION="${{ steps.deploy-source.outputs.version }}${{ steps.get-version.outputs.version }}"
          SOURCE="${{ steps.deploy-source.outputs.source }}"

          echo "## üîç Dry Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment would have been performed with:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** ${{ steps.deploy-source.outputs.project }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          if [ "$SOURCE" = "tag" ]; then
            echo "- **Source:** Tag (${{ inputs.tag }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Source:** Branch (${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ÑπÔ∏è No actual deployment occurred (dry_run=true)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To perform actual deployment, re-run with dry_run=false" >> $GITHUB_STEP_SUMMARY

      - name: Deployment summary
        if: inputs.dry_run == false
        run: |
          VERSION="${{ steps.deploy-source.outputs.version }}${{ steps.get-version.outputs.version }}"
          SOURCE="${{ steps.deploy-source.outputs.source }}"

          echo "## ‚úÖ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Successfully deployed:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** ${{ steps.deploy-source.outputs.project }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          if [ "$SOURCE" = "tag" ]; then
            echo "- **Source:** Tag (${{ inputs.tag }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Source:** Branch (${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
