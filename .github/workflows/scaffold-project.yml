name: Scaffold New Project

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name (lowercase with underscores, e.g., new_ml_project)'
        required: true
        type: string
      project_description:
        description: 'Short description of the project'
        required: true
        type: string
      project_type:
        description: 'Type of project'
        required: true
        type: choice
        options:
          - ml_pipeline
          - data_pipeline
          - custom
      create_pr:
        description: 'Create pull request after scaffolding'
        required: false
        type: boolean
        default: true

jobs:
  scaffold:
    name: Scaffold ${{ inputs.project_name }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Validate project name
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"

          # Validate format (lowercase, underscores only)
          if [[ ! "$PROJECT_NAME" =~ ^[a-z][a-z0-9_]*$ ]]; then
            echo "âŒ Error: Project name must start with a letter and contain only lowercase letters, numbers, and underscores"
            exit 1
          fi

          echo "âœ… Project name valid: $PROJECT_NAME"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if project already exists
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"

          if [ -d "projects/$PROJECT_NAME" ]; then
            echo "âŒ Error: Project 'projects/$PROJECT_NAME' already exists"
            exit 1
          fi

          echo "âœ… Project name available"

      - name: Create project structure
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"
          PROJECT_DESC="${{ inputs.project_description }}"
          PROJECT_TYPE="${{ inputs.project_type }}"

          echo "Creating project structure for: $PROJECT_NAME"

          # Create directory structure
          mkdir -p "projects/$PROJECT_NAME"/{src,notebooks,tests,resources}

          echo "âœ… Created directory structure"

      - name: Create version.yml
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"

          cat > "projects/$PROJECT_NAME/version.yml" << 'EOF'
# Version configuration for PROJECT_NAME_PLACEHOLDER project
version:
  code: "0.1.0"
  model_name: "PROJECT_NAME_PLACEHOLDER_model"
  model_version: "1.0.0"
EOF

          sed -i.bak "s/PROJECT_NAME_PLACEHOLDER/$PROJECT_NAME/g" "projects/$PROJECT_NAME/version.yml"
          rm -f "projects/$PROJECT_NAME/version.yml.bak"

          echo "âœ… Created version.yml"

      - name: Create Python package files
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"
          PROJECT_DESC="${{ inputs.project_description }}"

          # Create src/__init__.py
          {
            echo '"""'
            echo "$PROJECT_DESC"
            echo ""
            echo "This package contains utilities and code for the $PROJECT_NAME project."
            echo '"""'
            echo ""
            echo '__version__ = "0.1.0"'
          } > "projects/$PROJECT_NAME/src/__init__.py"

          # Create tests/__init__.py
          touch "projects/$PROJECT_NAME/tests/__init__.py"

          # Create tests/conftest.py
          {
            echo '"""'
            echo "Pytest configuration and fixtures for $PROJECT_NAME tests."
            echo '"""'
            echo ""
            echo "import pytest"
            echo ""
            echo ""
            echo "@pytest.fixture"
            echo "def sample_data():"
            echo '    """Fixture for sample test data."""'
            echo '    return {"test": "data"}'
          } > "projects/$PROJECT_NAME/tests/conftest.py"

          echo "âœ… Created Python package files"

      - name: Create setup.py
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"
          PROJECT_DESC="${{ inputs.project_description }}"

          {
            echo '"""'
            echo "Setup configuration for $PROJECT_NAME package."
            echo '"""'
            echo ""
            echo "from setuptools import setup, find_packages"
            echo ""
            echo "setup("
            echo "    name=\"$PROJECT_NAME\","
            echo "    version=\"0.1.0\","
            echo "    description=\"$PROJECT_DESC\","
            echo "    author=\"Data Science Team\","
            echo "    packages=find_packages(),"
            echo "    install_requires=["
            echo "        \"pyspark>=3.5.0\","
            echo "        \"pandas>=2.0.0\","
            echo "        \"numpy>=1.24.0\","
            echo "    ],"
            echo "    python_requires=\">=3.10\","
            echo ")"
          } > "projects/$PROJECT_NAME/setup.py"

          echo "âœ… Created setup.py"

      - name: Create requirements-dev.txt
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"

          cat > "projects/$PROJECT_NAME/requirements-dev.txt" << 'EOF'
# Development dependencies

# Testing
pytest>=7.4.0
pytest-cov>=4.1.0
pytest-mock>=3.11.1

# Code quality
black>=23.7.0
isort>=5.12.0
flake8>=6.1.0
mypy>=1.5.0

# Linting
pylint>=2.17.5

# Security
bandit>=1.7.5
safety>=2.3.5

# PySpark (for local testing)
pyspark>=3.5.0

# Data science
pandas>=2.0.0
numpy>=1.24.0
EOF

          echo "âœ… Created requirements-dev.txt"

      - name: Create pytest.ini
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"

          cat > "projects/$PROJECT_NAME/pytest.ini" << 'EOF'
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts =
    -v
    --tb=short
    --strict-markers
    --disable-warnings
markers =
    unit: Unit tests
    integration: Integration tests
    slow: Slow running tests
EOF

          echo "âœ… Created pytest.ini"

      - name: Create databricks.yml
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"
          PROJECT_DESC="${{ inputs.project_description }}"

          # Convert underscores to hyphens for bundle name
          BUNDLE_NAME=$(echo "$PROJECT_NAME" | tr '_' '-')

          cat > "projects/$PROJECT_NAME/databricks.yml" << 'EOF'
# Databricks Asset Bundle configuration for $PROJECT_NAME_PLACEHOLDER project
bundle:
  name: $BUNDLE_NAME_PLACEHOLDER

variables:
  # Environment-specific variables
  catalog:
    description: Unity Catalog name
    default: dev_catalog
  schema:
    description: Schema name within catalog
    default: $PROJECT_NAME_PLACEHOLDER

  # Compute configuration
  cluster_node_type:
    description: Node type for interactive clusters
    default: i3.xlarge

targets:
  # Development environment
  dev:
    mode: development
    default: true
    workspace:
      host: https://your-workspace.cloud.databricks.com
      root_path: ~/.bundle/${bundle.name}/${bundle.target}
    variables:
      catalog: dev_catalog
      schema: ${bundle.name}_dev

  # Staging environment
  staging:
    mode: production
    workspace:
      host: https://your-workspace.cloud.databricks.com
      root_path: /Shared/.bundle/${bundle.name}/${bundle.target}
    variables:
      catalog: staging_catalog
      schema: ${bundle.name}_staging
    run_as:
      service_principal_name: sp-${bundle.name}-staging

  # Production environment
  prod:
    mode: production
    workspace:
      host: https://your-workspace.cloud.databricks.com
      root_path: /Shared/.bundle/${bundle.name}/${bundle.target}
    variables:
      catalog: prod_catalog
      schema: ${bundle.name}_prod
    run_as:
      service_principal_name: sp-${bundle.name}-prod

include:
  - resources/*.yml

artifacts:
  # Python package artifacts
  libraries:
    type: whl
    path: ./dist

  # Notebook artifacts
  notebooks:
    type: notebook
    path: ./notebooks

permissions:
  # Bundle-level permissions
  - level: CAN_MANAGE
    group_name: data-science-team

  - level: CAN_VIEW
    group_name: analytics-team
EOF

          sed -i "s/\$PROJECT_NAME_PLACEHOLDER/$PROJECT_NAME/g" "projects/$PROJECT_NAME/databricks.yml"
          sed -i "s/\$BUNDLE_NAME_PLACEHOLDER/$BUNDLE_NAME/g" "projects/$PROJECT_NAME/databricks.yml"

          echo "âœ… Created databricks.yml"

      - name: Create resource files
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"

          # Create empty resource files
          cat > "projects/$PROJECT_NAME/resources/jobs.yml" << 'EOF'
# Databricks Jobs resources
resources:
  jobs:
    # Add your job definitions here
EOF

          cat > "projects/$PROJECT_NAME/resources/pipelines.yml" << 'EOF'
# Delta Live Tables pipelines
resources:
  pipelines:
    # Add your DLT pipeline definitions here
EOF

          cat > "projects/$PROJECT_NAME/resources/experiments.yml" << 'EOF'
# MLflow Experiments
resources:
  experiments:
    # Add your experiment definitions here
EOF

          cat > "projects/$PROJECT_NAME/resources/models.yml" << 'EOF'
# MLflow Models
resources:
  registered_models:
    # Add your model registry definitions here
EOF

          cat > "projects/$PROJECT_NAME/resources/model_serving.yml" << 'EOF'
# Model Serving Endpoints
resources:
  model_serving_endpoints:
    # Add your serving endpoint definitions here
EOF

          echo "âœ… Created resource files"

      - name: Create README.md
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"
          PROJECT_DESC="${{ inputs.project_description }}"
          DISPLAY_NAME=$(echo "$PROJECT_NAME" | tr '_' ' ' | sed 's/\b\(.\)/\u\1/g')

          cat > "projects/$PROJECT_NAME/README.md" << 'EOF'
# $DISPLAY_NAME_PLACEHOLDER

Databricks Asset Bundle for $PROJECT_DESC_PLACEHOLDER.

## Overview

$PROJECT_DESC_PLACEHOLDER

## Project Structure

```
$PROJECT_NAME_PLACEHOLDER/
â”œâ”€â”€ databricks.yml              # Main bundle configuration
â”œâ”€â”€ resources/                  # Resource definitions
â”‚   â”œâ”€â”€ jobs.yml               # Databricks jobs
â”‚   â”œâ”€â”€ pipelines.yml          # Delta Live Tables
â”‚   â”œâ”€â”€ experiments.yml        # MLflow experiments
â”‚   â”œâ”€â”€ models.yml             # MLflow model registry
â”‚   â””â”€â”€ model_serving.yml      # Model serving endpoints
â”œâ”€â”€ notebooks/                  # Databricks notebooks
â”œâ”€â”€ src/                        # Python source code
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ tests/                      # Unit tests
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ conftest.py
â”œâ”€â”€ setup.py                    # Package setup
â”œâ”€â”€ requirements-dev.txt        # Development dependencies
â”œâ”€â”€ pytest.ini                  # Pytest configuration
â””â”€â”€ version.yml                 # Version configuration
```

## Development

### Install dependencies
```bash
cd projects/$PROJECT_NAME_PLACEHOLDER
pip install -e .
pip install -r requirements-dev.txt
```

### Run tests
```bash
pytest tests/ -v
```

### Run code quality checks
```bash
# Format code
black src/ tests/
isort src/ tests/

# Lint code
flake8 src/ tests/
pylint src/

# Type check
mypy src/
```

## Deployment

### Deploy to Development
```bash
cd projects/$PROJECT_NAME_PLACEHOLDER
databricks bundle deploy -t dev
```

### Deploy to Staging
```bash
databricks bundle deploy -t staging
```

### Deploy to Production
```bash
databricks bundle deploy -t prod
```

## Version

Current version: 0.1.0

## Requirements

- Databricks Runtime 14.3 LTS or higher
- Unity Catalog enabled
- Python 3.10+
EOF

          sed -i "s/\$PROJECT_NAME_PLACEHOLDER/$PROJECT_NAME/g" "projects/$PROJECT_NAME/README.md"
          sed -i "s/\$PROJECT_DESC_PLACEHOLDER/$PROJECT_DESC/g" "projects/$PROJECT_NAME/README.md"
          sed -i "s/\$DISPLAY_NAME_PLACEHOLDER/$DISPLAY_NAME/g" "projects/$PROJECT_NAME/README.md"

          echo "âœ… Created README.md"

      - name: Create sample test file
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"

          {
            echo '"""'
            echo "Sample tests for $PROJECT_NAME."
            echo '"""'
            echo ""
            echo "import pytest"
            echo ""
            echo ""
            echo "class TestSample:"
            echo '    """Sample test class."""'
            echo ""
            echo "    def test_version_exists(self):"
            echo '        """Test that version is defined."""'
            echo "        from $PROJECT_NAME import __version__"
            echo ""
            echo "        assert __version__ is not None"
            echo "        assert isinstance(__version__, str)"
            echo ""
            echo "    def test_sample_fixture(self, sample_data):"
            echo '        """Test sample fixture from conftest."""'
            echo "        assert sample_data is not None"
            echo '        assert "test" in sample_data'
          } > "projects/$PROJECT_NAME/tests/test_sample.py"

          echo "âœ… Created sample test file"

      - name: Create branch and commit
        id: commit
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"
          BRANCH_NAME="scaffold/$PROJECT_NAME"

          git checkout -b "$BRANCH_NAME"
          git add "projects/$PROJECT_NAME"
          git commit -m "Scaffold new project: $PROJECT_NAME

Created complete project structure for $PROJECT_NAME.

Project type: ${{ inputs.project_type }}
Description: ${{ inputs.project_description }}

Includes:
- Python package structure (src/, tests/)
- Databricks bundle configuration
- Resource definitions (jobs, pipelines, experiments, models, serving)
- Development tooling (pytest, black, flake8, mypy)
- Documentation (README.md)

Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          git push -u origin "$BRANCH_NAME"

          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Created branch and committed changes"

      - name: Create Pull Request
        if: inputs.create_pr == true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"
          PROJECT_DESC="${{ inputs.project_description }}"
          PROJECT_TYPE="${{ inputs.project_type }}"
          BRANCH_NAME="${{ steps.commit.outputs.branch }}"

          gh pr create \
            --title "Add new project: $PROJECT_NAME" \
            --body "## New Project Scaffolded

**Project Name:** $PROJECT_NAME
**Description:** $PROJECT_DESC
**Type:** $PROJECT_TYPE

### What's Included

This PR adds a complete project structure with:

- âœ… Python package structure (\`src/\`, \`tests/\`)
- âœ… Databricks bundle configuration (\`databricks.yml\`)
- âœ… Resource definitions (jobs, pipelines, experiments, models, serving)
- âœ… Development dependencies (\`requirements-dev.txt\`)
- âœ… Testing configuration (\`pytest.ini\`)
- âœ… Package setup (\`setup.py\`)
- âœ… Documentation (\`README.md\`)
- âœ… Sample test file

### Next Steps

1. Review the generated structure
2. Update \`databricks.yml\` with actual workspace URLs
3. Add your notebooks to \`notebooks/\`
4. Add your source code to \`src/\`
5. Update resource definitions in \`resources/\`
6. Update README with project-specific details

### Deployment

Once merged, the project will be:
- Validated by CI/CD on future changes
- Available for bundle deployment with tags

ðŸ¤– Generated with GitHub Actions" \
            --head "$BRANCH_NAME" \
            --base master

          echo "âœ… Created pull request"

      - name: Summary
        run: |
          PROJECT_NAME="${{ inputs.project_name }}"
          BRANCH_NAME="${{ steps.commit.outputs.branch }}"

          echo "## âœ… Project Scaffolding Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project Name:** $PROJECT_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Description:** ${{ inputs.project_description }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ inputs.project_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Created Structure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ \`projects/$PROJECT_NAME/\`" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ“„ \`databricks.yml\` - Bundle configuration" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ“„ \`version.yml\` - Version configuration" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ“„ \`setup.py\` - Package setup" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ“„ \`README.md\` - Documentation" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ“„ \`pytest.ini\` - Test configuration" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ“„ \`requirements-dev.txt\` - Dev dependencies" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ“ \`src/\` - Source code" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ“ \`tests/\` - Unit tests" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ“ \`notebooks/\` - Databricks notebooks" >> $GITHUB_STEP_SUMMARY
          echo "  - ðŸ“ \`resources/\` - Resource definitions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.create_pr }}" = "true" ]; then
            echo "### ðŸ”— Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the changes in branch \`$BRANCH_NAME\` and create a PR manually if needed." >> $GITHUB_STEP_SUMMARY
          fi
