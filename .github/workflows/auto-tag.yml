name: Auto Tag Projects

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'projects/**'

jobs:
  tag-projects:
    name: Create Tags for Changed Projects
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Detect changed projects and create tags
        run: |
          # Get changed files in the push
          CHANGED_FILES=$(git diff --name-only HEAD^..HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Find unique project directories that have changes
          CHANGED_PROJECTS=$(echo "$CHANGED_FILES" | grep '^projects/' | cut -d'/' -f2 | sort -u)

          if [ -z "$CHANGED_PROJECTS" ]; then
            echo "No project changes detected"
            exit 0
          fi

          echo "Changed projects:"
          echo "$CHANGED_PROJECTS"
          echo ""

          # Process each changed project
          for project in $CHANGED_PROJECTS; do
            echo "Processing project: $project"

            # Check if project has version.yml
            VERSION_FILE="projects/$project/version.yml"
            if [ ! -f "$VERSION_FILE" ]; then
              echo "⚠️  Warning: $VERSION_FILE not found, skipping tagging"
              continue
            fi

            # Extract version from version.yml
            VERSION=$(grep -E "^\s+code:\s+" "$VERSION_FILE" | sed -E 's/.*code:\s+"([^"]+)".*/\1/')

            if [ -z "$VERSION" ]; then
              echo "⚠️  Warning: Could not extract version from $VERSION_FILE, skipping tagging"
              continue
            fi

            # Extract model info for tag annotation
            MODEL_NAME=$(grep -E "^\s+model_name:\s+" "$VERSION_FILE" | sed -E 's/.*model_name:\s+"([^"]+)".*/\1/')
            MODEL_VERSION=$(grep -E "^\s+model_version:\s+" "$VERSION_FILE" | sed -E 's/.*model_version:\s+"([^"]+)".*/\1/')

            # Create tag name
            TAG_NAME="${project}-${VERSION}"

            echo "Creating tag: $TAG_NAME"
            echo "  Code version: $VERSION"
            echo "  Model name: $MODEL_NAME"
            echo "  Model version: $MODEL_VERSION"

            # Check if tag already exists
            if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
              echo "ℹ️  Tag $TAG_NAME already exists, skipping"
              continue
            fi

            # Create and push the tag with detailed message
            TAG_MESSAGE="Release $project version $VERSION

Code Version: $VERSION
Model Name: $MODEL_NAME
Model Version: $MODEL_VERSION"

            git tag -a "$TAG_NAME" -m "$TAG_MESSAGE"
            git push origin "$TAG_NAME"

            echo "✅ Successfully created and pushed tag: $TAG_NAME"
            echo ""
          done

          echo "Tagging complete"
