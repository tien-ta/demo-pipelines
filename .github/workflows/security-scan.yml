name: Security Scan

on:
  pull_request:
    paths:
      - 'projects/**/*.py'
      - 'projects/**/requirements.txt'
      - 'projects/**/setup.py'

jobs:
  security-scan:
    name: Security Scan - ${{ matrix.project }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - high_risk_wifi
          - suspicious_location

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        run: |
          echo "Setting up Python 3.10"
          echo "✓ Python setup (dry-run mode)"

      - name: Install security tools
        run: |
          echo "Installing security scanning tools"
          echo "Running: pip install bandit safety"
          echo "✓ Security tools installed (dry-run mode)"

      - name: Run Bandit security scan
        working-directory: projects/${{ matrix.project }}
        run: |
          echo "Running Bandit security scan for ${{ matrix.project }}"
          if [ -d "src" ]; then
            echo "Running: bandit -r src/ -ll"
            echo "✓ Source code security scan passed (dry-run mode - 0 issues found)"
          fi
          if [ -d "notebooks" ]; then
            echo "Running: bandit -r notebooks/ -ll"
            echo "✓ Notebook security scan passed (dry-run mode - 0 issues found)"
          fi

      - name: Check for secrets in code
        working-directory: projects/${{ matrix.project }}
        run: |
          echo "Checking for hardcoded secrets in ${{ matrix.project }}"
          echo "Scanning for patterns:"
          echo "  - password = ..."
          echo "  - api_key = ..."
          echo "  - secret = ..."
          echo "  - token = ..."
          echo "  - aws_access_key_id"
          echo "  - aws_secret_access_key"
          echo ""
          echo "✓ No hardcoded secrets detected (dry-run mode)"

      - name: Check dependency vulnerabilities
        working-directory: projects/${{ matrix.project }}
        run: |
          echo "Checking dependencies for known vulnerabilities in ${{ matrix.project }}"
          if [ -f "setup.py" ]; then
            echo "Running: safety check --json"
            echo "✓ No dependency vulnerabilities found (dry-run mode)"
          fi

      - name: Upload Bandit report
        if: always()
        run: |
          echo "Uploading Bandit security report"
          echo "✓ Report uploaded (dry-run mode)"
